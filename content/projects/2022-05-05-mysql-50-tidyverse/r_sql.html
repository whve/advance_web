---
title: MySQL经典50题tidyverse版
author: whve
date: '2022-05-05'
slug: r_sql
categories:
  - tutorial
tags:
  - tidyverse
---



<p><span class="math inline">\(\quad\quad\)</span><strong>MySQL/SQL经典50题</strong>在互联网上广为流传，其中一个比较精美的版本是：来自 <strong>Python 数据之道</strong> 的<strong>《超经典 MySQL 练习50题》</strong>。</p>
<p><span class="math inline">\(\quad\quad\)</span>R 语言的 tidyverse 包，涵盖整个数据科学流程，也包括 SQL 数据库功能，数据操作整洁、优雅，读它的代码就像读文字叙述一样。</p>
<blockquote>
<p>阅读本文档内容，需要了解一点最基本的管道操作：</p>
</blockquote>
<blockquote>
<p>管道符号 <code>%&gt;%</code> 的作用是将前面的数据自动往前输送，依次用于每步操作，从此每步代码不用再管数据，只关心每步如何操作数据即可。</p>
</blockquote>
<div style="page-break-after: always;"></div>
<ul>
<li>加载包</li>
</ul>
<pre class="r"><code>library(tidyverse)
library(lubridate)</code></pre>
<div id="创建表" class="section level3">
<h3>创建表</h3>
<ul>
<li>按列创建表用 <code>tibble()</code>, 按行录入式地创建表用 <code>tribble()</code></li>
</ul>
<pre class="r"><code>student = tribble(
  ~学号, ~姓名, ~生日, ~性别,
  &#39;01&#39;, &#39;赵雷&#39;, &#39;1990-01-01&#39;, &#39;男&#39;, 
  &#39;02&#39;, &#39;钱电&#39;, &#39;1990-12-21&#39;, &#39;男&#39;,
  &#39;03&#39;, &#39;孙风&#39;, &#39;1990-05-20&#39;, &#39;男&#39;,
  &#39;04&#39;, &#39;李云&#39;, &#39;1990-08-06&#39;, &#39;男&#39;,
  &#39;05&#39;, &#39;周梅&#39;, &#39;1991-12-01&#39;, &#39;女&#39;,
  &#39;06&#39;, &#39;吴兰&#39;, &#39;1992-03-01&#39;, &#39;女&#39;,
  &#39;07&#39;, &#39;郑竹&#39;, &#39;1989-07-01&#39;, &#39;女&#39;,
  &#39;08&#39;, &#39;王菊&#39;, &#39;1990-01-20&#39;, &#39;女&#39;
)
student</code></pre>
<pre><code>## # A tibble: 8 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    赵雷  1990-01-01 男   
## 2 02    钱电  1990-12-21 男   
## 3 03    孙风  1990-05-20 男   
## 4 04    李云  1990-08-06 男   
## 5 05    周梅  1991-12-01 女   
## 6 06    吴兰  1992-03-01 女   
## # … with 2 more rows</code></pre>
<pre class="r"><code>score = tribble(
  ~学号, ~课程编号, ~成绩,
  &#39;01&#39;, &#39;01&#39;, 80,
  &#39;01&#39;, &#39;02&#39;, 90,
  &#39;01&#39;, &#39;03&#39;, 99,
  &#39;02&#39;, &#39;01&#39;, 70,
  &#39;02&#39;, &#39;02&#39;, 60,
  &#39;02&#39;, &#39;03&#39;, 80,
  &#39;03&#39;, &#39;01&#39;, 80,
  &#39;03&#39;, &#39;02&#39;, 80,
  &#39;03&#39;, &#39;03&#39;, 80,
  &#39;04&#39;, &#39;01&#39;, 50,
  &#39;04&#39;, &#39;02&#39;, 30,
  &#39;04&#39;, &#39;03&#39;, 20,
  &#39;05&#39;, &#39;01&#39;, 76,
  &#39;05&#39;, &#39;02&#39;, 87,
  &#39;06&#39;, &#39;01&#39;, 31,
  &#39;06&#39;, &#39;03&#39;, 34,
  &#39;07&#39;, &#39;02&#39;, 89,
  &#39;07&#39;, &#39;03&#39;, 98
)
score</code></pre>
<pre><code>## # A tibble: 18 × 3
##   学号  课程编号  成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 01    01          80
## 2 01    02          90
## 3 01    03          99
## 4 02    01          70
## 5 02    02          60
## 6 02    03          80
## # … with 12 more rows</code></pre>
<pre class="r"><code>course = tribble(
  ~课程编号, ~课程名称, ~教师编号,
  &#39;01&#39;, &#39;语文&#39;, &#39;02&#39;,
  &#39;02&#39;, &#39;数学&#39;, &#39;01&#39;,
  &#39;03&#39;, &#39;英语&#39;, &#39;03&#39;
)
course</code></pre>
<pre><code>## # A tibble: 3 × 3
##   课程编号 课程名称 教师编号
##   &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;   
## 1 01       语文     02      
## 2 02       数学     01      
## 3 03       英语     03</code></pre>
<pre class="r"><code>teacher = tribble(
  ~教师编号, ~教师姓名,
  &#39;01&#39;, &#39;张三&#39;,
  &#39;02&#39;, &#39;李四&#39;,
  &#39;03&#39;, &#39;王五&#39;
)
teacher</code></pre>
<pre><code>## # A tibble: 3 × 2
##   教师编号 教师姓名
##   &lt;chr&gt;    &lt;chr&gt;   
## 1 01       张三    
## 2 02       李四    
## 3 03       王五</code></pre>
<ul>
<li>保存上述 4 个数据表，以方便后续使用</li>
</ul>
<pre class="r"><code>save(course, score, student, teacher, 
     file = &quot;SQL50datas.rda&quot;)
load(&quot;SQL50datas.rda&quot;)         # 载入数据</code></pre>
</div>
<div id="查询01课程比02课程成绩高的学生的信息及课程分数" class="section level3">
<h3>1. 查询”01”课程比”02”课程成绩<strong>高</strong>的学生的信息及课程分数</h3>
<ul>
<li>先长变宽重塑为宽表，然后根据条件筛选行，再连接学生信息</li>
</ul>
<pre class="r"><code># 为了方便理解,先看一看这个宽表
score1 = score %&gt;% 
  pivot_wider(names_from = 课程编号, values_from = 成绩,
              names_prefix = &quot;课程&quot;) 
score1</code></pre>
<pre><code>## # A tibble: 7 × 4
##   学号  课程01 课程02 课程03
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 01        80     90     99
## 2 02        70     60     80
## 3 03        80     80     80
## 4 04        50     30     20
## 5 05        76     87     NA
## 6 06        31     NA     34
## # … with 1 more row</code></pre>
<pre class="r"><code>score1 %&gt;% 
  filter(课程01 &gt; 课程02) %&gt;% 
  left_join(student, by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 2 × 7
##   学号  课程01 课程02 课程03 姓名  生日       性别 
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 02        70     60     80 钱电  1990-12-21 男   
## 2 04        50     30     20 李云  1990-08-06 男</code></pre>
</div>
<div id="查询01课程比02课程成绩低的学生的信息及课程分数" class="section level3">
<h3>2. 查询”01”课程比”02”课程成绩<strong>低</strong>的学生的信息及课程分数</h3>
<ul>
<li>直接使用新创建的宽表</li>
</ul>
<pre class="r"><code>score1 %&gt;% 
  filter(课程01 &lt; 课程02) %&gt;% 
  left_join(student, by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 2 × 7
##   学号  课程01 课程02 课程03 姓名  生日       性别 
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01        80     90     99 赵雷  1990-01-01 男   
## 2 05        76     87     NA 周梅  1991-12-01 女</code></pre>
</div>
<div id="查询平均成绩大于等于60分的学生学号姓名和平均成绩" class="section level3">
<h3>3. 查询平均成绩大于等于60分的学生学号、姓名和平均成绩</h3>
<ul>
<li>先分组汇总计算平均成绩，然后根据条件筛选行，再连接学生信息，最后选择列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(学号) %&gt;% 
  summarise(平均成绩 = mean(成绩)) %&gt;% 
  filter(平均成绩 &gt;= 60) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名, 平均成绩)</code></pre>
<pre><code>## # A tibble: 5 × 3
##   学号  姓名  平均成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 01    赵雷      89.7
## 2 02    钱电      70  
## 3 03    孙风      80  
## 4 05    周梅      81.5
## 5 07    郑竹      93.5</code></pre>
<div id="附加题-总分超过200分的学生学号姓名总分" class="section level4">
<h4>附加题: 总分超过200分的学生学号、姓名、总分</h4>
<ul>
<li>思路相同，只是从汇总平均分改成汇总总分</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(学号) %&gt;% 
  summarise(总分 = sum(成绩)) %&gt;% 
  filter(总分 &gt; 200) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名, 总分)</code></pre>
<pre><code>## # A tibble: 3 × 3
##   学号  姓名   总分
##   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
## 1 01    赵雷    269
## 2 02    钱电    210
## 3 03    孙风    240</code></pre>
</div>
</div>
<div id="查询平均成绩小于60-分的学生的学号和姓名和平均成绩包括有成绩的和无成绩的" class="section level3">
<h3>4. 查询平均成绩小于60 分的学生的学号和姓名和平均成绩（包括有成绩的和无成绩的）</h3>
<ul>
<li>数据中是有一名学生没有任何考试成绩的，如果不考虑该生，即只考虑有成绩的学生</li>
<li>先以成绩表作为左表连接学生信息，然后分组汇总计算平均成绩，再根据条件筛选行</li>
</ul>
<pre class="r"><code>score %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;%
  group_by(学号, 姓名) %&gt;% 
  summarise(平均成绩 = mean(成绩)) %&gt;% 
  filter(平均成绩 &lt; 60)</code></pre>
<pre><code>## # A tibble: 2 × 3
## # Groups:   学号 [2]
##   学号  姓名  平均成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 04    李云      33.3
## 2 06    吴兰      32.5</code></pre>
<ul>
<li>若考虑所有学生，无论有没有成绩，没有成绩做 0 分处理</li>
<li>以学生表作为左表连接成绩表，将缺失成绩插补为 0 分，再做上述事情</li>
</ul>
<pre class="r"><code>student %&gt;% 
  left_join(score, by = &quot;学号&quot;) %&gt;% 
  replace_na(list(成绩 = 0)) %&gt;% 
  group_by(学号, 姓名) %&gt;% 
  summarise(平均成绩 = mean(成绩)) %&gt;% 
  filter(平均成绩 &lt; 60)</code></pre>
<pre><code>## # A tibble: 3 × 3
## # Groups:   学号 [3]
##   学号  姓名  平均成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 04    李云      33.3
## 2 06    吴兰      32.5
## 3 08    王菊       0</code></pre>
</div>
<div id="查询所有学生的学号姓名选课总数所有课程的总成绩" class="section level3">
<h3>5. 查询所有学生的学号、姓名、选课总数、所有课程的总成绩</h3>
<ul>
<li>同上面一样，改用另一种方式： <code>mutate()</code> 修改列的方式，将缺失成绩插补为 0 分</li>
<li>再做分组汇总，函数 <code>n_distinct()</code> 是对唯一值计数，因为没有成绩学生的课程是缺失，计算时需忽略缺失值</li>
</ul>
<pre class="r"><code>student %&gt;% 
  left_join(score, by = &quot;学号&quot;) %&gt;%
  mutate(成绩 = replace_na(成绩, 0)) %&gt;% 
  group_by(学号, 姓名) %&gt;%
  summarise(选课总数 = n_distinct(课程编号, na.rm = TRUE), 
            总成绩 = sum(成绩))</code></pre>
<pre><code>## # A tibble: 8 × 4
## # Groups:   学号 [8]
##   学号  姓名  选课总数 总成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;int&gt;  &lt;dbl&gt;
## 1 01    赵雷         3    269
## 2 02    钱电         3    210
## 3 03    孙风         3    240
## 4 04    李云         3    100
## 5 05    周梅         2    163
## 6 06    吴兰         2     65
## # … with 2 more rows</code></pre>
</div>
<div id="查询李姓老师的数量" class="section level3">
<h3>6. 查询”李”姓老师的数量</h3>
<ul>
<li>先计算新列，<code>str_detect()</code> 检测字符串匹配返回 <code>TRUE/FALSE</code>，<code>"^李"</code> 是正则表达式，匹配以”李”开头</li>
<li>对逻辑值列求和就是计数</li>
</ul>
<pre class="r"><code>teacher %&gt;% 
  mutate(idx = str_detect(教师姓名, &quot;^李&quot;)) %&gt;% 
  summarise(n = sum(idx))</code></pre>
<pre><code>## # A tibble: 1 × 1
##       n
##   &lt;int&gt;
## 1     1</code></pre>
<ul>
<li>或者，直接用 <code>count()</code> 做分组计数，需提供分组变量或分组条件表示的分组变量，本例是后者</li>
</ul>
<pre class="r"><code>teacher %&gt;% 
  count(是否李姓 = str_detect(教师姓名, &quot;^李&quot;))</code></pre>
<pre><code>## # A tibble: 2 × 2
##   是否李姓     n
##   &lt;lgl&gt;    &lt;int&gt;
## 1 FALSE        2
## 2 TRUE         1</code></pre>
</div>
<div id="查询学过张三老师教授课程的学生信息" class="section level3">
<h3>7. 查询学过张三老师教授课程的学生信息</h3>
<ul>
<li>先以教师表作为左表连接课程表，根据条件筛选行，得到张三老师教授课程</li>
<li>然后根据上步选出的课程连接成绩表，得到学过相应课程的学号</li>
<li>再用上步选出的学号去<strong>筛选</strong>学生表得到学生信息，半连接 <code>semi_join()</code> 正好适合：根据与第 2 个表匹配筛选第 1 个表，<code>.</code> 代表上一步通过管道输送过来的数据，用做第 2 个表</li>
<li>管道输送的数据，默认是用于函数的第一个参数，并默认省略不写，若想用于非第一个参数时，必须用 <code>.</code> 来代替该数据</li>
</ul>
<pre class="r"><code>teacher %&gt;% 
  left_join(course, by = &quot;教师编号&quot;) %&gt;% 
  filter(教师姓名 == &quot;张三&quot;) %&gt;% 
  left_join(score, by = &quot;课程编号&quot;) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 6 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    赵雷  1990-01-01 男   
## 2 02    钱电  1990-12-21 男   
## 3 03    孙风  1990-05-20 男   
## 4 04    李云  1990-08-06 男   
## 5 05    周梅  1991-12-01 女   
## 6 07    郑竹  1989-07-01 女</code></pre>
</div>
<div id="找出没有学过张三老师教授课程的学生信息" class="section level3">
<h3>8. 找出没有学过张三老师教授课程的学生信息</h3>
<ul>
<li>与上一题相似，<strong>筛选</strong>换成<strong>反选</strong>，只需要将 <code>semi_join()</code> 换成反连接 <code>anti_join()</code></li>
</ul>
<pre class="r"><code>teacher %&gt;% 
  left_join(course, by = &quot;教师编号&quot;) %&gt;% 
  filter(教师姓名 == &quot;张三&quot;) %&gt;% 
  left_join(score, by = &quot;课程编号&quot;) %&gt;% 
  anti_join(student, ., by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 2 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 06    吴兰  1992-03-01 女   
## 2 08    王菊  1990-01-20 女</code></pre>
</div>
<div id="查询学过01和02课程的学生信息" class="section level3">
<h3>9. 查询学过”01”和”02”课程的学生信息</h3>
<ul>
<li>成绩宽表 <code>score1</code> 课程列不是 <code>NA</code> 就是学过，作为条件筛选行</li>
<li>再用于半连接筛选学生表，得到学生信息</li>
</ul>
<pre class="r"><code>score1 %&gt;% 
  filter(!is.na(课程01), !is.na(课程02)) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 5 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    赵雷  1990-01-01 男   
## 2 02    钱电  1990-12-21 男   
## 3 03    孙风  1990-05-20 男   
## 4 04    李云  1990-08-06 男   
## 5 05    周梅  1991-12-01 女</code></pre>
<ul>
<li><strong>“你为长安”的解法</strong>：先分别选出两个课程的学号，再依次与学生表做半连接筛选学生信息</li>
</ul>
<pre class="r"><code>class1 = score %&gt;% 
  filter(课程编号 == &quot;01&quot;)
class2 = score %&gt;% 
  filter(课程编号 == &quot;02&quot;)
class1 %&gt;% 
  semi_join(class2, by = &quot;学号&quot;) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
</div>
<div id="查询学过01课程但没有学过02课程的学生信息" class="section level3">
<h3>10. 查询学过”01”课程，但没有学过”02”课程的学生信息</h3>
<ul>
<li>道理同上题(略)</li>
</ul>
<pre class="r"><code>score1 %&gt;% 
  filter(!is.na(课程01), is.na(课程02)) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 1 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 06    吴兰  1992-03-01 女</code></pre>
<ul>
<li><strong>“你为长安”的解法</strong></li>
</ul>
<pre class="r"><code>class1 = score %&gt;% 
  filter(课程编号 == &quot;01&quot;)
class2 = score %&gt;% 
  filter(课程编号 == &quot;02&quot;)
class1 %&gt;% 
  anti_join(class2, by = &quot;学号&quot;) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
</div>
<div id="查询没有学完全部课程的学生信息" class="section level3">
<h3>11. 查询没有学完全部课程的学生信息</h3>
<ul>
<li>假设成绩表中出现的课程就是全部课程，直接使用成绩宽表</li>
<li>左连接学生表，获得学生信息</li>
<li>没有学完全部课程，即 3 个课程列存在 <code>NA</code>，根据多列的值构造判断条件做筛选行，适合用 <code>filter + if_any/if_all</code> 实现，多列存在值满足条件用 <code>if_any(选择列, 判断条件)</code></li>
</ul>
<pre class="r"><code>score1 %&gt;% 
  right_join(student, by = &quot;学号&quot;) %&gt;% 
  filter(if_any(2:4, is.na)) %&gt;% 
  select(-(2:4))</code></pre>
<pre><code>## # A tibble: 4 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 05    周梅  1991-12-01 女   
## 2 06    吴兰  1992-03-01 女   
## 3 07    郑竹  1989-07-01 女   
## 4 08    王菊  1990-01-20 女</code></pre>
<ul>
<li>更稳妥的做法是从课程表出发，用下面的结果表代替 <code>score1</code>:</li>
</ul>
<pre class="r"><code>course %&gt;% 
  left_join(score, by = &quot;课程编号&quot;) %&gt;%
  select(-c(课程编号, 教师编号)) %&gt;% 
  pivot_wider(names_from = 课程名称, values_from = 成绩)</code></pre>
<ul>
<li><strong>“PORPOIS”的解法：</strong> 成绩宽表剔除 3 个课程列包含 <code>NA</code> 的行，就是选择全部课程的学生，用其学号反选(反连接)学生表即可</li>
</ul>
<pre class="r"><code>score1 %&gt;%
  drop_na(课程01, 课程02, 课程03) %&gt;% 
  anti_join(student, ., by = &quot;学号&quot;)</code></pre>
<ul>
<li><strong>“偏居一隅”的解法(很巧妙地把课程表用进来)：</strong> 成绩表根据学号分组，<code>n()</code> 即每个学生学完的课程数，若等于总课程数则筛选出来，再反连接学生表</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(学号) %&gt;% 
  filter(n() == nrow(course)) %&gt;% 
  anti_join(student, ., by = &quot;学号&quot;)</code></pre>
</div>
<div id="查询至少有一门课与学生01所学课程相同的学生信息" class="section level3">
<h3>12. 查询至少有一门课与学生”01”所学课程相同的学生信息</h3>
<ul>
<li>成绩表筛选学生”01”的行，其中的课程编号就是该生所学课程</li>
<li>用来与成绩表做半连接，筛选成绩表中这些课程的行，得到学过这些课程的学生学号</li>
<li>再与学生表做半连接，筛选出想要的学生信息</li>
</ul>
<pre class="r"><code>score %&gt;% 
  filter(学号 == &quot;01&quot;) %&gt;%
  semi_join(score, ., by = &quot;课程编号&quot;) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 7 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    赵雷  1990-01-01 男   
## 2 02    钱电  1990-12-21 男   
## 3 03    孙风  1990-05-20 男   
## 4 04    李云  1990-08-06 男   
## 5 05    周梅  1991-12-01 女   
## 6 06    吴兰  1992-03-01 女   
## # … with 1 more row</code></pre>
</div>
<div id="查询与学生01学习的课程完全相同的学生信息" class="section level3">
<h3>13. 查询与学生”01”学习的课程完全相同的学生信息</h3>
<ul>
<li>先从成绩表筛选学生”01”的行，准备好该生的所有课程编号</li>
<li>用 <code>group_nest()</code> 对成绩表按学号做分组嵌套，这样的好处是，每个学生的数据占一行，其所有课程及成绩信息打包成一个对象(数据框)。为了方便理解，打断管道操作先看一下它：</li>
</ul>
<pre class="r"><code>c01 = score %&gt;% 
  filter(学号 == &quot;01&quot;)

score_nest = score %&gt;% 
  group_nest(学号) 
score_nest</code></pre>
<pre><code>## # A tibble: 7 × 2
##   学号                data
##   &lt;chr&gt; &lt;list&lt;tibble[,2]&gt;&gt;
## 1 01               [3 × 2]
## 2 02               [3 × 2]
## 3 03               [3 × 2]
## 4 04               [3 × 2]
## 5 05               [2 × 2]
## 6 06               [2 × 2]
## # … with 1 more row</code></pre>
<pre class="r"><code>score_nest$data[[1]]   </code></pre>
<pre><code>## # A tibble: 3 × 2
##   课程编号  成绩
##   &lt;chr&gt;    &lt;dbl&gt;
## 1 01          80
## 2 02          90
## 3 03          99</code></pre>
<ul>
<li>从嵌套成绩表继续，要筛选满足条件的学号，条件是其所有课程编号与学生”01”的相同，即两个课程编号集合相等</li>
<li>筛选行用 <code>filter()</code>, 构造一个逻辑向量作为筛选条件，该逻辑向量由判断课程编号集合是否相等得到</li>
<li>这相当于依次从 <code>data</code> 列中取出其课程编号集合，与学生”01”的课程编号集合，做是否集合相等判断</li>
<li>这种循环迭代操作，适合用 <code>purrr</code> 包的 <code>map</code> 系列来做，返回类型是逻辑值，所以用带后缀的 <code>map_lgl()</code></li>
<li>其第 1 个参数 <code>data</code> 表明是在 <code>data</code> 列上依次迭代，第 2 个参数是要应用的函数(判断集合相等)，这里是用 <code>purrr-风格公式</code>(匿名函数)写法，形参 <code>.x</code> 代指一元函数的自变量</li>
<li>在 <code>map</code> 机制下，该函数将依次应用到 <code>data</code> 列的每个元素上，完成咱们想要的判断</li>
<li>这样筛选出的学号，再用半连接筛选学生表，得到最终结果</li>
</ul>
<pre class="r"><code>score_nest %&gt;% 
  filter(map_lgl(data, ~ setequal(.x$课程编号, c01$课程编号))) %&gt;%
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
<pre><code>## # A tibble: 4 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    赵雷  1990-01-01 男   
## 2 02    钱电  1990-12-21 男   
## 3 03    孙风  1990-05-20 男   
## 4 04    李云  1990-08-06 男</code></pre>
<p><span class="math inline">\(\quad\quad\)</span>上述做法代码不复杂(去掉中间变量把管道接一起)，但是很抽象难以理解。受<strong>“偏居一隅”</strong>启发，与其放一起作为集合比较集合相等，何不拼接为一个字符串，比较字符串？</p>
<ul>
<li>对成绩表按学号分组，将同一学号所选课程，合并为一个字符串。为了不受先后顺序的影响，应该先用 <code>arrange()</code> 对学号排个序</li>
<li>然后筛选出所选课程汇编字符串与学生”01”相同的学号</li>
<li>再与学生表做半连接，筛选学生信息</li>
</ul>
<pre class="r"><code>score %&gt;% 
  arrange(学号) %&gt;% 
  group_by(学号) %&gt;% 
  summarise(课程汇编 = str_c(课程编号, collapse = &quot;,&quot;)) %&gt;% 
  filter(课程汇编 == .$课程汇编[学号==&quot;01&quot;]) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;)</code></pre>
<p><strong>注：</strong> 本题可以说所有题目中最难的一道，虽然很啰嗦但穿插讲解到很多语法，还是很有意义的。另外，<code>group_by + summarise(str_c)</code> 是 <code>separate_rows()</code> 的逆操作。</p>
</div>
<div id="同-8.-略" class="section level3">
<h3>14. 同 8. (略)</h3>
</div>
<div id="查询两门及以上不及格课程的学生学号姓名及其平均成绩" class="section level3">
<h3>15. 查询两门及以上不及格课程的学生学号，姓名及其平均成绩</h3>
<ul>
<li>从成绩宽表开始，用 <code>filter()</code> 根据条件筛选行，条件是两门及以上课程不及格</li>
<li>三门课程占据 3 列，先判断是否不及格，再对逻辑值加和，就是不及格的门数(要注意忽略 <code>NA</code>)，再判断是否 <code>≥2</code></li>
<li>每一行是一个学生，相当于依次对每一行做出判断，这叫做数据框逐行迭代，<code>purrr</code> 包中的 <code>pmap</code> 系列 就是做这个的，想要返回逻辑值作为筛选条件，所以用带后缀的 <code>pmap_lgl()</code></li>
<li>其第 1 个参数就是三门课程列构成的数据框，第 2 个参数是要应用的函数(判断条件)，其形参 <code>...</code> 代表使用该行所有的列值，注意需要套一个 <code>c()</code> 打包成一个对象</li>
<li>上述筛选就选出了满足条件的学生，接着是计算平均成绩，计算新列用 <code>mutate()</code>, 基本格式是 <code>新列名 = 计算表达式</code></li>
<li>仍是逐行迭代计算平均值，注意忽略 <code>NA</code>, 仍用 <code>pmap</code> 系列实现，区别是这次返回的是数值，所以用带后缀的 <code>pmap_dbl()</code></li>
<li>最后，再连接学生信息进来，若不想带着多余列，用 <code>select()</code> 选择想要的列</li>
</ul>
<pre class="r"><code>score1 %&gt;%
  filter(pmap_lgl(.[-1], ~ sum(c(...) &lt; 60, na.rm = TRUE) &gt;= 2)) %&gt;% 
  mutate(平均成绩 = pmap_dbl(.[-1], ~ mean(c(...), na.rm = TRUE))) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名, 平均成绩)</code></pre>
<pre><code>## # A tibble: 2 × 3
##   学号  姓名  平均成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 04    李云      33.3
## 2 06    吴兰      32.5</code></pre>
</div>
<div id="检索01课程分数小于60按分数降序排列的学生信息" class="section level3">
<h3>16. 检索”01”课程分数小于60，按分数降序排列的学生信息</h3>
<ul>
<li>用 <code>filter()</code> 筛选行，其实是两个筛选条件</li>
<li>把学生信息连接进来，用 <code>select()</code> 选择列：删除课程编号列</li>
<li>最后用 <code>arrange()</code> 根据成绩列排序，默认是增序，要降序加<code>-</code>或套一个 <code>desc()</code></li>
</ul>
<pre class="r"><code>score %&gt;% 
  filter(课程编号 == &quot;01&quot;, 成绩 &lt; 60) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(-课程编号) %&gt;% 
  arrange(-成绩)</code></pre>
<pre><code>## # A tibble: 2 × 5
##   学号   成绩 姓名  生日       性别 
##   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 04       50 李云  1990-08-06 男   
## 2 06       31 吴兰  1992-03-01 女</code></pre>
</div>
<div id="按平均成绩从高到低显示所有学生的所有课程的成绩以及平均成绩" class="section level3">
<h3>17. 按平均成绩从高到低显示所有学生的所有课程的成绩以及平均成绩</h3>
<ul>
<li>对成绩表按学号做分组汇总，计算平均成绩，再对平均成绩按降序排序</li>
</ul>
<pre class="r"><code># 长表
score %&gt;% 
  group_by(学号) %&gt;% 
  mutate(平均成绩 = mean(成绩)) %&gt;% 
  arrange(-平均成绩)</code></pre>
<pre><code>## # A tibble: 18 × 4
## # Groups:   学号 [7]
##   学号  课程编号  成绩 平均成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 07    02          89     93.5
## 2 07    03          98     93.5
## 3 01    01          80     89.7
## 4 01    02          90     89.7
## 5 01    03          99     89.7
## 6 05    01          76     81.5
## # … with 12 more rows</code></pre>
<ul>
<li>上面是按长表实现，若要按成绩宽表实现，同 15. 做法逐行迭代计算平均成绩再排序</li>
</ul>
<pre class="r"><code>score1 %&gt;%
  mutate(平均成绩 = pmap_dbl(.[-1], ~ mean(c(...), na.rm = TRUE))) %&gt;% 
  arrange(-平均成绩)</code></pre>
<pre><code>## # A tibble: 7 × 5
##   学号  课程01 课程02 课程03 平均成绩
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
## 1 07        NA     89     98     93.5
## 2 01        80     90     99     89.7
## 3 05        76     87     NA     81.5
## 4 03        80     80     80     80  
## 5 02        70     60     80     70  
## 6 04        50     30     20     33.3
## # … with 1 more row</code></pre>
</div>
<div id="查询各科成绩最高分最低分和平均分以如下形式显示" class="section level3">
<h3>18. 查询各科成绩最高分、最低分和平均分，以如下形式显示：</h3>
<blockquote>
<p>课程编号，课程名称，最高分，最低分，平均分，及格率，中等率，优良率，优秀率；</p>
</blockquote>
<blockquote>
<p>注： 及格：&gt;=60，中等为：70-80，优良为：80-90，优秀为：&gt;=90</p>
</blockquote>
<ul>
<li>分组汇总，这里用到一个小技巧是：<strong>对是否满足某条件的逻辑向量取平均，就是该条件的占比</strong></li>
<li><code>relocate()</code> 函数用来调整列序</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  summarise(最高分 = max(成绩), 
            最低分 = min(成绩), 
            平均分 = mean(成绩), 
            及格率 = mean(成绩 &gt;= 60), 
            中等率 = mean(成绩 &gt;= 70 &amp; 成绩 &lt; 80),
            优秀率 = mean(成绩 &gt;= 90)) %&gt;% 
  left_join(course, by = &quot;课程编号&quot;) %&gt;% 
  relocate(课程名称, .after = 课程编号) %&gt;% 
  select(-教师编号)</code></pre>
<pre><code>## # A tibble: 3 × 8
##   课程编号 课程名称 最高分 最低分 平均分 及格率 中等率 优秀率
##   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 01       语文         80     31   64.5  0.667  0.333  0    
## 2 02       数学         90     30   72.7  0.833  0      0.167
## 3 03       英语         99     20   68.5  0.667  0      0.333</code></pre>
</div>
<div id="按照各科成绩进行排序并且显示排名" class="section level3">
<h3>19. 按照各科成绩进行排序，并且显示排名</h3>
<ul>
<li>成绩表先根据课程编号分组，计算排名是用 <code>rank()</code></li>
<li>排名时涉及到<strong>对相同分数怎么排名</strong>的问题，多个相同值在一起叫做”结”，怎么处理”结”通常有六种方法</li>
<li>对成绩排名，一般是这样排：第 1 名，两个第 2 名，第 4 名 …… 这叫做用 “min” 方法处理 “结”</li>
<li>有两种实现，更简单的实现是直接用 <code>min_rank()</code>，来自”小小不聪明”的做法</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  mutate(排名 = min_rank(-成绩)) %&gt;%   # 来自&quot;小小不聪明&quot;
  arrange(课程编号, 排名)</code></pre>
<pre><code>## # A tibble: 18 × 4
## # Groups:   课程编号 [3]
##   学号  课程编号  成绩  排名
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;int&gt;
## 1 01    01          80     1
## 2 03    01          80     1
## 3 05    01          76     3
## 4 02    01          70     4
## 5 04    01          50     5
## 6 06    01          31     6
## # … with 12 more rows</code></pre>
</div>
<div id="查询学生的总成绩并进行排名" class="section level3">
<h3>20. 查询学生的总成绩，并进行排名</h3>
<ul>
<li>类似上题(略)</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(学号) %&gt;% 
  summarise(总成绩 = sum(成绩)) %&gt;% 
  mutate(排名 = min_rank(-总成绩)) %&gt;% 
  arrange(排名)</code></pre>
<pre><code>## # A tibble: 7 × 3
##   学号  总成绩  排名
##   &lt;chr&gt;  &lt;dbl&gt; &lt;int&gt;
## 1 01       269     1
## 2 03       240     2
## 3 02       210     3
## 4 07       187     4
## 5 05       163     5
## 6 04       100     6
## # … with 1 more row</code></pre>
</div>
<div id="查询不同老师所教不同课程平均分从高到低显示" class="section level3">
<h3>21. 查询不同老师所教不同课程平均分从高到低显示</h3>
<ul>
<li>需要成绩、课程、教师信息，来自三个表，将它们连接起来</li>
<li>按教师、课程分组汇总计算平均分</li>
<li>成绩排名同上</li>
</ul>
<pre class="r"><code>score %&gt;% 
  left_join(course, by = &quot;课程编号&quot;) %&gt;% 
  left_join(teacher, by = &quot;教师编号&quot;) %&gt;% 
  group_by(教师姓名, 课程名称) %&gt;% 
  summarise(平均成绩 = mean(成绩)) %&gt;% 
  arrange(-平均成绩)</code></pre>
<pre><code>## # A tibble: 3 × 3
## # Groups:   教师姓名 [3]
##   教师姓名 课程名称 平均成绩
##   &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt;
## 1 张三     数学         72.7
## 2 王五     英语         68.5
## 3 李四     语文         64.5</code></pre>
</div>
<div id="查询所有课程的成绩第2至3名的学生信息及该课程成绩" class="section level3">
<h3>22. 查询所有课程的成绩第2至3名的学生信息及该课程成绩</h3>
<ul>
<li>分组修改：按课程分组，计算成绩排名，则为每门课程的成绩排名</li>
<li>筛选行：排名为 2 或 3</li>
<li>排序行：按课程、排名排序让结果更整齐</li>
<li>左连接：学生信息，需要连接学生表进来</li>
<li>选择列：删除不想显示的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  mutate(排名 = rank(-成绩, ties.method = &quot;first&quot;)) %&gt;% 
  filter(排名 %in% 2:3) %&gt;% 
  arrange(课程编号, 排名) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(-c(课程编号, 排名))</code></pre>
<pre><code>## # A tibble: 6 × 6
## # Groups:   课程编号 [3]
##   课程编号 学号   成绩 姓名  生日       性别 
##   &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01       03       80 孙风  1990-05-20 男   
## 2 01       05       76 周梅  1991-12-01 女   
## 3 02       07       89 郑竹  1989-07-01 女   
## 4 02       05       87 周梅  1991-12-01 女   
## 5 03       07       98 郑竹  1989-07-01 女   
## 6 03       02       80 钱电  1990-12-21 男</code></pre>
</div>
<div id="统计各科成绩各分数段人数课程编号课程名称8510070856070060-及所占百分比" class="section level3">
<h3>23. 统计各科成绩各分数段人数：课程编号，课程名称，[85,100]，[70,85)，[60,70)，[0,60) 及所占百分比</h3>
<ul>
<li>分组修改：按课程分组，用<code>cut</code>将成绩离散化为分数段</li>
<li>按课程、分数段分组计数</li>
<li>修改列：人数除以各科人数之和，计算百分比，注意当前分组变量是课程编号，<code>sum(n)</code> 就是对同一课程下的人数加和</li>
<li>左连接：需要课程信息，将课程表连接进来</li>
<li>选择列：删除不想显示的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  mutate(分数段 = cut(成绩, breaks = c(0,60,70,85,100), right = FALSE)) %&gt;% 
  count(课程编号, 分数段) %&gt;%
  mutate(百分比 = scales::percent(n / sum(n), accuracy = 0.01)) %&gt;% 
  left_join(course, by = &quot;课程编号&quot;) %&gt;% 
  select(-教师编号)</code></pre>
<pre><code>## # A tibble: 9 × 5
## # Groups:   课程编号 [3]
##   课程编号 分数段       n 百分比 课程名称
##   &lt;chr&gt;    &lt;fct&gt;    &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;   
## 1 01       [0,60)       2 33.33% 语文    
## 2 01       [70,85)      4 66.67% 语文    
## 3 02       [0,60)       1 16.67% 数学    
## 4 02       [60,70)      1 16.67% 数学    
## 5 02       [70,85)      1 16.67% 数学    
## 6 02       [85,100)     3 50.00% 数学    
## # … with 3 more rows</code></pre>
</div>
<div id="查询学生的平均成绩及名次" class="section level3">
<h3>24. 查询学生的平均成绩及名次</h3>
<ul>
<li>分组汇总：按学号分组汇总每个学生的平均成绩</li>
<li>按平均成绩计算排名并排序，同前文</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(学号) %&gt;% 
  summarise(平均成绩 = mean(成绩)) %&gt;% 
  mutate(排名 = min_rank(-平均成绩)) %&gt;% 
  arrange(排名)</code></pre>
<pre><code>## # A tibble: 7 × 3
##   学号  平均成绩  排名
##   &lt;chr&gt;    &lt;dbl&gt; &lt;int&gt;
## 1 07        93.5     1
## 2 01        89.7     2
## 3 05        81.5     3
## 4 03        80       4
## 5 02        70       5
## 6 04        33.3     6
## # … with 1 more row</code></pre>
</div>
<div id="查询各科成绩前三名的记录" class="section level3">
<h3>25. 查询各科成绩前三名的记录</h3>
<ul>
<li>分组筛选行：根据课程分组，做取最大行切片</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  slice_max(成绩, n = 3)</code></pre>
<pre><code>## # A tibble: 10 × 3
## # Groups:   课程编号 [3]
##   学号  课程编号  成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 01    01          80
## 2 03    01          80
## 3 05    01          76
## 4 01    02          90
## 5 07    02          89
## 6 05    02          87
## # … with 4 more rows</code></pre>
</div>
<div id="查询每门课被选修的学生数" class="section level3">
<h3>26. 查询每门课被选修的学生数</h3>
<ul>
<li>按课程分组计数，即计算学生人数</li>
</ul>
<pre class="r"><code>score %&gt;% 
  count(课程编号)</code></pre>
<pre><code>## # A tibble: 3 × 2
##   课程编号     n
##   &lt;chr&gt;    &lt;int&gt;
## 1 01           6
## 2 02           6
## 3 03           6</code></pre>
</div>
<div id="查询出只有两门课程的全部学生的学号和姓名" class="section level3">
<h3>27. 查询出只有两门课程的全部学生的学号和姓名</h3>
<ul>
<li>按学号分组计数，即每个学号所学的课程数，选出为2的行</li>
<li>半连接合并相应的学生信息进来，就是根据在右表，筛选左表的行</li>
<li>选择想要的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  count(学号) %&gt;% 
  filter(n == 2) %&gt;% 
  semi_join(student, ., by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名)</code></pre>
<pre><code>## # A tibble: 3 × 2
##   学号  姓名 
##   &lt;chr&gt; &lt;chr&gt;
## 1 05    周梅 
## 2 06    吴兰 
## 3 07    郑竹</code></pre>
</div>
<div id="查询男女生人数" class="section level3">
<h3>28. 查询男女生人数</h3>
<ul>
<li>按性别分组计数</li>
</ul>
<pre class="r"><code>student %&gt;% 
  count(性别)</code></pre>
<pre><code>## # A tibble: 2 × 2
##   性别      n
##   &lt;chr&gt; &lt;int&gt;
## 1 女        4
## 2 男        4</code></pre>
</div>
<div id="查询名字中含有风字的学生信息" class="section level3">
<h3>29. 查询名字中含有风字的学生信息</h3>
<ul>
<li>根据条件：姓名是否包含”风”，筛选行</li>
</ul>
<pre class="r"><code>student %&gt;% 
  filter(str_detect(姓名, &quot;风&quot;))</code></pre>
<pre><code>## # A tibble: 1 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 03    孙风  1990-05-20 男</code></pre>
</div>
<div id="查询同姓名同性别的学生名单并统计同姓名人数" class="section level3">
<h3>30. 查询同姓名同性别的学生名单，并统计同姓名人数</h3>
<ul>
<li>按姓名、性别分组计数，数目大于 1 说明二者出现重复</li>
<li>同理，选出姓名重复，有几行就是有几个同姓名</li>
</ul>
<pre class="r"><code>student %&gt;% 
  count(姓名, 性别) %&gt;% 
  filter(n &gt; 1)</code></pre>
<pre><code>## # A tibble: 0 × 3
## # … with 3 variables: 姓名 &lt;chr&gt;, 性别 &lt;chr&gt;, n &lt;int&gt;</code></pre>
<pre class="r"><code>student %&gt;% 
  count(姓名) %&gt;% 
  filter(n &gt; 1) %&gt;% 
  summarise(n = n())</code></pre>
<pre><code>## # A tibble: 1 × 1
##       n
##   &lt;int&gt;
## 1     0</code></pre>
</div>
<div id="查询1990年出生的学生信息" class="section level3">
<h3>31. 查询1990年出生的学生信息</h3>
<ul>
<li>根据条件：生日的年份等于1990, 筛选行</li>
</ul>
<pre class="r"><code>student %&gt;% 
  filter(year(生日) == 1990)</code></pre>
<pre><code>## # A tibble: 5 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    赵雷  1990-01-01 男   
## 2 02    钱电  1990-12-21 男   
## 3 03    孙风  1990-05-20 男   
## 4 04    李云  1990-08-06 男   
## 5 08    王菊  1990-01-20 女</code></pre>
</div>
<div id="计算每门课程的平均成绩并按降序排列若平均成绩相同按课程编号升序排列" class="section level3">
<h3>32. 计算每门课程的平均成绩，并按降序排列；若平均成绩相同，按课程编号升序排列</h3>
<ul>
<li>分组汇总+排序</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  summarise(平均成绩 = mean(成绩)) %&gt;% 
  arrange(-平均成绩, 课程编号)</code></pre>
<pre><code>## # A tibble: 3 × 2
##   课程编号 平均成绩
##   &lt;chr&gt;       &lt;dbl&gt;
## 1 02           72.7
## 2 03           68.5
## 3 01           64.5</code></pre>
</div>
<div id="查询平均成绩-85-分的学生学号姓名和平均成绩" class="section level3">
<h3>33. 查询平均成绩 <code>≥85</code> 分的学生学号、姓名和平均成绩</h3>
<ul>
<li>先按学号分组汇总计算平均成绩</li>
<li>根据平均成绩 <code>≥85</code> 分，筛选行</li>
<li>再左连接，将学生信息合并进来，选择想要的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(学号) %&gt;% 
  summarise(平均成绩 = mean(成绩)) %&gt;% 
  filter(平均成绩 &gt;= 85) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名, 平均成绩)</code></pre>
<pre><code>## # A tibble: 2 × 3
##   学号  姓名  平均成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 01    赵雷      89.7
## 2 07    郑竹      93.5</code></pre>
</div>
<div id="查询课程名称为数学且分数低于60的学生姓名和分数" class="section level3">
<h3>34. 查询课程名称为数学，且分数低于60的学生姓名和分数</h3>
<ul>
<li>成绩表左连接，将课程信息合并进来</li>
<li>根据条件：课程名称等于数学且分数低于60, 筛选行</li>
<li>左连接，将学生信息合并进来，选择想要的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  left_join(course, by = &quot;课程编号&quot;) %&gt;% 
  filter(课程名称 == &quot;数学&quot;, 成绩 &lt; 60) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(姓名, 成绩)</code></pre>
<pre><code>## # A tibble: 1 × 2
##   姓名   成绩
##   &lt;chr&gt; &lt;dbl&gt;
## 1 李云     30</code></pre>
</div>
<div id="查询所有学生的课程及分数情况" class="section level3">
<h3>35. 查询所有学生的课程及分数情况</h3>
<ul>
<li>成绩表左连接，将课程信息合并进来，删除没用的列</li>
<li>宽变长，变成每个学号占一行，每科成绩占一列</li>
<li>右连接学生信息，相当于以学生表为左表，选择想要的列</li>
<li>修改列：按行加和，忽略<code>NA</code>, 计算每个学生的总分
<ul>
<li><code>pmap_dbl()</code>逐行迭代返回浮点向量</li>
<li><code>.[3:5]</code>是从数据框中选择列范围</li>
<li><code>...</code> 代表每行的三科成绩，需要用<code>c()</code>打包到一起</li>
<li>忽略<code>NA</code>, 用<code>sum</code>求和</li>
</ul></li>
</ul>
<pre class="r"><code>score %&gt;% 
  left_join(course, by = &quot;课程编号&quot;) %&gt;% 
  select(-c(课程编号, 教师编号)) %&gt;% 
  pivot_wider(names_from = 课程名称, values_from = 成绩) %&gt;%
  right_join(student, by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名, 语文, 数学, 英语) %&gt;% 
  mutate(总分 = pmap_dbl(.[3:5], ~ sum(c(...), na.rm = TRUE)))</code></pre>
<pre><code>## # A tibble: 8 × 6
##   学号  姓名   语文  数学  英语  总分
##   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 01    赵雷     80    90    99   269
## 2 02    钱电     70    60    80   210
## 3 03    孙风     80    80    80   240
## 4 04    李云     50    30    20   100
## 5 05    周梅     76    87    NA   163
## 6 06    吴兰     31    NA    34    65
## # … with 2 more rows</code></pre>
</div>
<div id="查询任何一门课程成绩都在70分以上的姓名课程名称和分数" class="section level3">
<h3>36. 查询任何一门课程成绩都在70分以上的姓名、课程名称和分数</h3>
<ul>
<li>前面步骤同35题</li>
<li>根据多列值构造筛选条件：所有成绩都大于70分，正常是用 <code>filter(if_all(2:4, ~ .x &gt; 70))</code>，这里想忽略<code>NA</code>再做判断，采用的是逐行迭代的逻辑：
<ul>
<li><code>pmap_lgl()</code>逐行迭代返回逻辑向量</li>
<li><code>.[2:4]</code>是从数据框中选择列范围</li>
<li><code>...</code> 代表每行的三科成绩，需要用<code>c()</code>打包到一起</li>
<li>忽略 <code>NA</code> 判断 <code>&gt;70</code>，再取<code>all()</code></li>
</ul></li>
<li>左连接，将学生信息合并进来，再选择想要的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  left_join(course, by = &quot;课程编号&quot;) %&gt;% 
  select(-c(课程编号, 教师编号)) %&gt;% 
  pivot_wider(names_from = 课程名称, values_from = 成绩) %&gt;%
  filter(pmap_lgl(.[2:4], ~ all(na.omit(c(...)) &gt; 70))) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名, 语文, 数学, 英语) </code></pre>
<pre><code>## # A tibble: 4 × 5
##   学号  姓名   语文  数学  英语
##   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 01    赵雷     80    90    99
## 2 03    孙风     80    80    80
## 3 05    周梅     76    87    NA
## 4 07    郑竹     NA    89    98</code></pre>
</div>
<div id="查询不及格的课程" class="section level3">
<h3>37. 查询不及格的课程</h3>
<ul>
<li>根据不及格条件筛选行</li>
<li>左连接，将课程信息合并进来</li>
<li>选择想要的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  filter(成绩 &lt; 60) %&gt;% 
  left_join(course, by = &quot;课程编号&quot;) %&gt;% 
  select(课程编号, 课程名称, 成绩)</code></pre>
<pre><code>## # A tibble: 5 × 3
##   课程编号 课程名称  成绩
##   &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;
## 1 01       语文        50
## 2 02       数学        30
## 3 03       英语        20
## 4 01       语文        31
## 5 03       英语        34</code></pre>
</div>
<div id="查询课程01的成绩大于等于80的学生学号和姓名" class="section level3">
<h3>38. 查询课程01的成绩大于等于80的学生学号和姓名</h3>
<ul>
<li>根据课程条件筛选行</li>
<li>左连接，将学生信息合并进来</li>
<li>选择想要的列</li>
</ul>
<pre class="r"><code>score %&gt;% 
  filter(课程编号 == &quot;01&quot;, 成绩 &gt;= 80) %&gt;% 
  left_join(student, by = &quot;学号&quot;) %&gt;% 
  select(学号, 姓名, 成绩)</code></pre>
<pre><code>## # A tibble: 2 × 3
##   学号  姓名   成绩
##   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
## 1 01    赵雷     80
## 2 03    孙风     80</code></pre>
</div>
<div id="同-26.-略" class="section level3">
<h3>39. 同 26. (略)</h3>
</div>
<div id="查询选修张三老师所授课程的学生中成绩最高的学生信息及其成绩" class="section level3">
<h3>40. 查询选修”张三”老师所授课程的学生中，成绩最高的学生信息及其成绩</h3>
<ul>
<li>教师表左连接，将课程信息合并进来</li>
<li>根据教师姓名等于”张三”，筛选行，得到张三所授课程，将作为右表</li>
<li>与成绩表做半连接，即根据右表筛选左表，得到张三所授课程的成绩</li>
<li>对成绩，取最大做行切片，找到成绩最高的学号</li>
<li>左连接，将这些学号的学生信息合并进来</li>
</ul>
<pre class="r"><code>teacher %&gt;% 
  left_join(course, by = &quot;教师编号&quot;) %&gt;% 
  filter(教师姓名 == &quot;张三&quot;) %&gt;% 
  semi_join(score, ., by = &quot;课程编号&quot;) %&gt;% 
  slice_max(成绩) %&gt;% 
  left_join(student, by = &quot;学号&quot;) </code></pre>
<pre><code>## # A tibble: 1 × 6
##   学号  课程编号  成绩 姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    02          90 赵雷  1990-01-01 男</code></pre>
</div>
<div id="查询不同课程成绩相同的学生学号课程编号学生成绩" class="section level3">
<h3>41. 查询不同课程成绩相同的学生学号、课程编号、学生成绩</h3>
<ul>
<li>成绩表按课程分组，对成绩计数，统计的是每门课程各个成绩出现的次数</li>
<li>筛选次数&gt;1的行，就选出了成绩相同的课程，将作为右表</li>
<li>再与成绩表做半连接，实现根据右表筛选左表</li>
<li>为了结果更直观，按课程编号排序</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  count(成绩) %&gt;% 
  filter(n &gt; 1) %&gt;% 
  semi_join(score, ., by = c(&quot;课程编号&quot;, &quot;成绩&quot;)) %&gt;% 
  arrange(课程编号)</code></pre>
<pre><code>## # A tibble: 4 × 3
##   学号  课程编号  成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 01    01          80
## 2 03    01          80
## 3 02    03          80
## 4 03    03          80</code></pre>
</div>
<div id="查询每门课程成绩最好的前两名" class="section level3">
<h3>42. 查询每门课程成绩最好的前两名</h3>
<ul>
<li>类似25题</li>
</ul>
<pre class="r"><code>score %&gt;% 
  group_by(课程编号) %&gt;% 
  slice_max(成绩, n = 2)</code></pre>
<pre><code>## # A tibble: 6 × 3
## # Groups:   课程编号 [3]
##   学号  课程编号  成绩
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 01    01          80
## 2 03    01          80
## 3 01    02          90
## 4 07    02          89
## 5 01    03          99
## 6 07    03          98</code></pre>
</div>
<div id="统计每门课程的学生选修人数超过5-人的课程才统计要求输出课程号和选修人数查询结果按人数降序排列若人数相同按课程号升序排列" class="section level3">
<h3>43. 统计每门课程的学生选修人数（超过5 人的课程才统计）。要求输出课程号和选修人数，查询结果按人数降序排列，若人数相同，按课程号升序排列</h3>
<ul>
<li>按课程分组计数，得到每门课程的选修人数，接着筛选出大于5的行</li>
<li>按人数降序、课程号升序做行排序</li>
</ul>
<pre class="r"><code>score %&gt;% 
  count(课程编号) %&gt;% 
  filter(n &gt; 5) %&gt;% 
  arrange(-n, 课程编号)</code></pre>
<pre><code>## # A tibble: 3 × 2
##   课程编号     n
##   &lt;chr&gt;    &lt;int&gt;
## 1 01           6
## 2 02           6
## 3 03           6</code></pre>
</div>
<div id="检索至少选修两门课程的学生学号" class="section level3">
<h3>44. 检索至少选修两门课程的学生学号</h3>
<ul>
<li>按学号分组计数，就是每个学号的课程数</li>
<li>根据条件筛选行</li>
</ul>
<pre class="r"><code>score %&gt;% 
  count(学号) %&gt;% 
  filter(n &gt;= 2)</code></pre>
<pre><code>## # A tibble: 7 × 2
##   学号      n
##   &lt;chr&gt; &lt;int&gt;
## 1 01        3
## 2 02        3
## 3 03        3
## 4 04        3
## 5 05        2
## 6 06        2
## # … with 1 more row</code></pre>
</div>
<div id="查询选修了全部课程的学生信息" class="section level3">
<h3>45. 查询选修了全部课程的学生信息</h3>
<pre class="r"><code>course %&gt;% 
  left_join(score, by = &quot;课程编号&quot;) %&gt;%
  select(-c(课程编号, 教师编号)) %&gt;% 
  pivot_wider(names_from = 课程名称, values_from = 成绩) %&gt;% 
  right_join(student, by = &quot;学号&quot;) %&gt;% 
  filter(if_all(2:4, ~ !is.na(.x))) %&gt;% 
  select(-(2:4))</code></pre>
<pre><code>## # A tibble: 4 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
## 1 01    赵雷  1990-01-01 男   
## 2 02    钱电  1990-12-21 男   
## 3 03    孙风  1990-05-20 男   
## 4 04    李云  1990-08-06 男</code></pre>
</div>
<div id="查询各学生的年龄-按照出生日期来算-当前月日出生年月的月日-则年龄减1" class="section level3">
<h3>46. 查询各学生的年龄: 按照出生日期来算, 当前月日&lt;出生年月的月日, 则年龄减1</h3>
<ul>
<li>修改列：将生日转化为日期型</li>
<li>年龄就是生日至今天的时间段，整除单位1年，等于有几个1年</li>
</ul>
<pre class="r"><code>student %&gt;% 
  mutate(生日 = ymd(生日),
         年龄 = interval(生日, today()) %/% dyears(1))</code></pre>
<pre><code>## # A tibble: 8 × 5
##   学号  姓名  生日       性别   年龄
##   &lt;chr&gt; &lt;chr&gt; &lt;date&gt;     &lt;chr&gt; &lt;dbl&gt;
## 1 01    赵雷  1990-01-01 男       32
## 2 02    钱电  1990-12-21 男       31
## 3 03    孙风  1990-05-20 男       31
## 4 04    李云  1990-08-06 男       31
## 5 05    周梅  1991-12-01 女       30
## 6 06    吴兰  1992-03-01 女       30
## # … with 2 more rows</code></pre>
</div>
<div id="查询本周过生日的学生" class="section level3">
<h3>47. 查询本周过生日的学生</h3>
<ul>
<li>修改列：将生日转化为日期型</li>
<li>根据条件：生日周等于本周，筛选行</li>
</ul>
<pre class="r"><code>student %&gt;% 
  mutate(生日 = ymd(生日)) %&gt;% 
  filter(week(生日) == week(today()))</code></pre>
<pre><code>## # A tibble: 0 × 4
## # … with 4 variables: 学号 &lt;chr&gt;, 姓名 &lt;chr&gt;, 生日 &lt;date&gt;, 性别 &lt;chr&gt;</code></pre>
</div>
<div id="查询下周过生日的学生" class="section level3">
<h3>48. 查询下周过生日的学生</h3>
<ul>
<li>类似47题</li>
</ul>
<pre class="r"><code>student %&gt;% 
  mutate(生日 = ymd(生日)) %&gt;% 
  filter(week(生日) == week(today()) + 1)</code></pre>
<pre><code>## # A tibble: 0 × 4
## # … with 4 variables: 学号 &lt;chr&gt;, 姓名 &lt;chr&gt;, 生日 &lt;date&gt;, 性别 &lt;chr&gt;</code></pre>
</div>
<div id="查询本月过生日的学生" class="section level3">
<h3>49. 查询本月过生日的学生</h3>
<ul>
<li>类似47题</li>
</ul>
<pre class="r"><code>student %&gt;% 
  mutate(生日 = ymd(生日)) %&gt;% 
  filter(month(生日) == month(today()))</code></pre>
<pre><code>## # A tibble: 1 × 4
##   学号  姓名  生日       性别 
##   &lt;chr&gt; &lt;chr&gt; &lt;date&gt;     &lt;chr&gt;
## 1 03    孙风  1990-05-20 男</code></pre>
</div>
<div id="查询下月过生日的学生" class="section level3">
<h3>50. 查询下月过生日的学生</h3>
<ul>
<li>类似47题</li>
</ul>
<pre class="r"><code>student %&gt;% 
  mutate(生日 = ymd(生日)) %&gt;% 
  filter(month(生日) == month(today()) + 1)</code></pre>
<pre><code>## # A tibble: 0 × 4
## # … with 4 variables: 学号 &lt;chr&gt;, 姓名 &lt;chr&gt;, 生日 &lt;date&gt;, 性别 &lt;chr&gt;</code></pre>
</div>
